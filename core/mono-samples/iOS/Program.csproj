<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net5.0</TargetFramework>
    <RuntimeIdentifier>ios-x64</RuntimeIdentifier>
    <OutputType>Exe</OutputType>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.NET.Runtime.iOS.Sample.Mono" Version="6.0.0-dev" />
  </ItemGroup>

  <UsingTask TaskName="AppleAppBuilderTask"
             AssemblyFile="$(NuGetPackageRoot)microsoft.net.runtime.ios.sample.mono/6.0.0-dev/tools/net6.0/AppleAppBuilder.dll" />

  <Target Name="BuildAppBundle" AfterTargets="CopyFilesToPublishDirectory;Publish;BuildAppleAppBuilder">
    <PropertyGroup>
      <AppDir>$(MSBuildThisFileDirectory)$(PublishDir)</AppDir>
      <TargetArchitecture>x64</TargetArchitecture>
      <IosSimulator Condition="'$(TargetArchitecture)' == 'x64' or '$(TargetArchitecture)' == 'x86'">iPhone 11</IosSimulator>
      <Optimized Condition="'$(Configuration)' == 'Release'">True</Optimized>
    </PropertyGroup>

    <ItemGroup>
      <BundleAssemblies Include="$(AppDir)\*.dll" />
    </ItemGroup>

    <AppleAppBuilderTask
      ProjectName="HelloiOS"
      AppDir="$(AppDir)"
      MonoRuntimeHeaders="%(ResolvedRuntimePack.PackageDirectory)\runtimes\ios-x64\native\include\mono-2.0"
      MainLibraryFileName="$(MSBuildThisFileName).dll"
      Assemblies="@(BundleAssemblies)"
      OutputDirectory="$(AppDir)\app"
      Optimized="$(Optimized)"
      Arch="$(TargetArchitecture)"
      BuildAppBundle="True"
      GenerateXcodeProject="True"
      NativeMainSource="$(MSBuildThisFileDirectory)main.m"
      UseAotForSimulator="$(UseAotForSimulator)">
      <Output TaskParameter="AppBundlePath" PropertyName="AppBundlePath" />
      <Output TaskParameter="XcodeProjectPath" PropertyName="XcodeProjectPath" />
    </AppleAppBuilderTask>

    <Message Importance="High" Text="Xcode: $(XcodeProjectPath)"/>
    <Message Importance="High" Text="App:   $(AppBundlePath)"/>
    <Message Importance="High" Text="Restarting device"/>
    <Exec Condition="'$(IosSimulator)' != ''" Command="xcrun simctl shutdown &quot;$(IosSimulator)&quot;" ContinueOnError="WarnAndContinue" />
    <Exec Condition="'$(IosSimulator)' != ''" Command="xcrun simctl boot &quot;$(IosSimulator)&quot;" />
    <Exec Condition="'$(IosSimulator)' != ''" Command="open -a Simulator" />
    <Message Importance="High" Text="Installing application"/>
    <Exec Condition="'$(IosSimulator)' != ''" Command="xcrun simctl install &quot;$(IosSimulator)&quot; $(AppBundlePath)" />
    <Message Importance="High" Text="Launching application"/>
    <Exec Condition="'$(IosSimulator)' != ''" Command="xcrun simctl launch --console booted net.dot.HelloiOS" />
  </Target>
</Project>